#!/usr/bin/env bash
set -o errexit
set -o pipefail
set -o nounset
shopt -s lastpipe

declare -i print_command=0

main () {
    while (( $# )) ; do
        case "$1" in
            --print-command)
                print_command=1
                shift
                ;;
            --allow-excludes)
                exclude_dirs=()
                exclude_files=()
                shift
                ;;
            --list-excludes)
                list_excludes
                exit 0
                ;;
            --help)
                print_help
                exit 0
                ;;
            --grep)
                if (( $# < 2 )) ; then
                    echo "fe: option missing required argument - --grep"
                    exit 1
                fi
                grep="$2"
                shift 2
                ;;
            --grep=*)
                grep="${1#*=}"
                shift
                ;;
            --non-ascii)
                grep_patterns+=(
                    -e "[^[:space:][:graph:][:cntrl:]]"
                )
                shift
                ;;
            --css-class)
                grep_patterns+=(
                    -e '[Cc][Ll][Aa][Ss][Ss][ \t]*=[ \t]*("[^"]*"|'\''[^'\'']*'\''|[^<>[:space:]]+)'
                )
                shift
                ;;
            *)
                break
                ;;
        esac
    done
    declare -a command=(
        "${grep}" -I -r "${grep_options[@]}" "${exclude_dirs[@]}" "${exclude_files[@]}" "${grep_patterns[@]}" "$@"
    )
    if (( print_command )) ; then
        echo "${command[@]@Q}"
    else
        exec "${command[@]}"
    fi
}

declare -a grep_options=()
declare -a grep_patterns=()

if [[ "${TERM}" = "emacs-grep" ]] ; then
    # invoked from M-x grep, either directly or indirectly
    grep_options+=(--color=auto -nH --null)
fi

grep=grep
if [[ -v OSTYPE ]] && [[ "${OSTYPE}" = "darwin" ]] && type -P ggrep >/dev/null ; then
    grep=ggrep
fi

declare -a exclude_dirs=(
    --exclude-dir=.git
    --exclude-dir=node_modules
    --exclude-dir=_cacache
    --exclude-dir=.node-gyp
    --exclude-dir=vendor
    --exclude-dir=.cache
)

declare -a exclude_files=(
    --exclude='*~'
    --exclude='#*#'
    --exclude='*.tmp'
    --exclude='*.bak'
    --exclude='*.orig'
    --exclude='*.old'
    --exclude='*.tmp.*'
    --exclude='*.bak.*'
    --exclude='*.orig.*'
    --exclude='*.old.*'

    # executable
    --exclude='*.exe'
    --exclude='*.com'

    # shared libraries
    --exclude='*.so'
    --exclude='*.so.*'
    --exclude='*.dll'
    --exclude='*.dynlib'
    --exclude='*.dylib'

    # compiled formats
    --exclude='*.pyc'
    --exclude='*.elc'

    # image
    --exclude='*.jpg'
    --exclude='*.jpeg'
    --exclude='*.gif'
    --exclude='*.png'
    --exclude='*.bmp'
    --exclude='*.webp'
    --exclude='*.tif'
    --exclude='*.tiff'
    --exclude='*.ppm'
    --exclude='*.pgm'
    --exclude='*.pbm'
    --exclude='*.pnm'

    # audio
    --exclude='*.3gp'
    --exclude='*.aa'
    --exclude='*.aac'
    --exclude='*.aax'
    --exclude='*.act'
    --exclude='*.aiff'
    --exclude='*.alac'
    --exclude='*.amr'
    --exclude='*.ape'
    --exclude='*.au'
    --exclude='*.awb'
    --exclude='*.dss'
    --exclude='*.dvf'
    --exclude='*.flac'
    --exclude='*.gsm'
    --exclude='*.iklax'
    --exclude='*.ivs'
    --exclude='*.m4a'
    --exclude='*.m4b'
    --exclude='*.m4p'
    --exclude='*.mmf'
    --exclude='*.movpkg'
    --exclude='*.mp3'
    --exclude='*.mpc'
    --exclude='*.msv'
    --exclude='*.nmf'
    --exclude='*.ogg'
    --exclude='*.oga'
    --exclude='*.mogg'
    --exclude='*.opus'
    --exclude='*.ra'
    --exclude='*.rm'
    --exclude='*.raw'
    --exclude='*.rf64'
    --exclude='*.sln'
    --exclude='*.tta'
    --exclude='*.voc'
    --exclude='*.vox'
    --exclude='*.wav'
    --exclude='*.wma'
    --exclude='*.wv'
    --exclude='*.webm'
    --exclude='*.8svx'
    --exclude='*.cda'

    # video
    --exclude='*.webm'
    --exclude='*.mkv'
    --exclude='*.flv'
    --exclude='*.vob'
    --exclude='*.ogv'
    --exclude='*.ogg'
    --exclude='*.drc'
    --exclude='*.gif'
    --exclude='*.gifv'
    --exclude='*.mng'
    --exclude='*.avi'
    --exclude='*.MTS'
    --exclude='*.M2TS'
    --exclude='*.TS'
    --exclude='*.mov'
    --exclude='*.qt'
    --exclude='*.wmv'
    --exclude='*.yuv'
    --exclude='*.rm'
    --exclude='*.rmvb'
    --exclude='*.viv'
    --exclude='*.asf'
    --exclude='*.amv'
    --exclude='*.mp4'
    --exclude='*.m4p'
    --exclude='*.m4v'
    --exclude='*.mpg'
    --exclude='*.mp2'
    --exclude='*.mpeg'
    --exclude='*.mpe'
    --exclude='*.mpv'
    --exclude='*.mpg'
    --exclude='*.mpeg'
    --exclude='*.m2v'
    --exclude='*.m4v'
    --exclude='*.svi'
    --exclude='*.3gp'
    --exclude='*.3g2'
    --exclude='*.mxf'
    --exclude='*.roq'
    --exclude='*.nsv'
    --exclude='*.flv'
    --exclude='*.f4v'
    --exclude='*.f4p'
    --exclude='*.f4a'
    --exclude='*.f4b'

    # HEIF - High Efficiency Image File Format
    --exclude='*.heif'
    --exclude='*.heifs'
    --exclude='*.heic'
    --exclude='*.heics'
    --exclude='*.avci'
    --exclude='*.avcs'
    --exclude='*.HIF'

    # archive formats
    --exclude='*.a'
    --exclude='*.ar'
    --exclude='*.cpio'
    --exclude='*.shar'
    --exclude='*.LBR'
    --exclude='*.iso'
    --exclude='*.lbr'
    --exclude='*.mar'
    --exclude='*.sbx'
    --exclude='*.tar'

    # compression formats
    --exclude='*.br'
    --exclude='*.bz2'
    --exclude='*.F'
    --exclude='*.?XF'
    --exclude='*.genozip'
    --exclude='*.gz'
    --exclude='*.lz'
    --exclude='*.lz4'
    --exclude='*.lzma'
    --exclude='*.lzo'
    --exclude='*.rz'
    --exclude='*.sfark'
    --exclude='*.sz'
    --exclude='*.?Q?'
    --exclude='*.?Z?'
    --exclude='*.xz'
    --exclude='*.z'
    --exclude='*.Z'
    --exclude='*.zst'
    --exclude='*.??_'

    # archive and compression formats
    --exclude='*.7z'
    --exclude='*.s7z'
    --exclude='*.aar'
    --exclude='*.ace'
    --exclude='*.afa'
    --exclude='*.alz'
    --exclude='*.apk'
    --exclude='*.arc'
    --exclude='*.ark'
    --exclude='*.cdx'
    --exclude='*.arj'
    --exclude='*.b1'
    --exclude='*.b6z'
    --exclude='*.ba'
    --exclude='*.bh'
    --exclude='*.cab'
    --exclude='*.car'
    --exclude='*.cfs'
    --exclude='*.cpt'
    --exclude='*.dar'
    --exclude='*.dd'
    --exclude='*.dgc'
    --exclude='*.dmg'
    --exclude='*.ear'
    --exclude='*.gca'
    --exclude='*.genozip'
    --exclude='*.ha'
    --exclude='*.hki'
    --exclude='*.ice'
    --exclude='*.jar'
    --exclude='*.kgb'
    --exclude='*.lzh'
    --exclude='*.lza'
    --exclude='*.lzx'
    --exclude='*.pak'
    --exclude='*.partimg'
    --exclude='*.paq6'
    --exclude='*.paq7'
    --exclude='*.paq8'
    --exclude='*.pea'
    --exclude='*.phar'
    --exclude='*.pim'
    --exclude='*.pit'
    --exclude='*.qda'
    --exclude='*.rar'
    --exclude='*.rk'
    --exclude='*.sda'
    --exclude='*.sea'
    --exclude='*.sen'
    --exclude='*.sfx'
    --exclude='*.shk'
    --exclude='*.sit'
    --exclude='*.sitx'
    --exclude='*.sqx'
    --exclude='*.uc'
    --exclude='*.uc0'
    --exclude='*.uc2'
    --exclude='*.ucn'
    --exclude='*.ur2'
    --exclude='*.ue2'
    --exclude='*.uca'
    --exclude='*.uha'
    --exclude='*.war'
    --exclude='*.wim'
    --exclude='*.xar'
    --exclude='*.xp3'
    --exclude='*.yz1'
    --exclude='*.zip'
    --exclude='*.zipx'
    --exclude='*.zoo'
    --exclude='*.zpaq'
    --exclude='*.zz'

    # shorthands for *.tar.*
    --exclude='*.tgz'
    --exclude='*.tbz2'
    --exclude='*.tlz'
    --exclude='*.txz'

    # data recovery, error correction
    --exclude='*.ecc'
    --exclude='*.ecsbx'
    --exclude='*.par'
    --exclude='*.par2'
    --exclude='*.rev'

    # bloat
    --exclude='*.min'
    --exclude='*.min.*'
)

list_excludes () {
    echo "# directories"
    for i in "${exclude_dirs[@]}" ; do
        case "${i}" in
            --exclude=*|--exclude-dir=*)
                echo "${i#*=}"
                ;;
            *)
                echo "${i}"
                ;;
        esac
    done | if [[ -t 1 ]] ; then
        fmt
    else
        cat
    fi
    echo "# files"
    for i in "${exclude_files[@]}" ; do
        case "${i}" in
            --exclude=*|--exclude-dir=*)
                echo "${i#*=}"
                ;;
            *)
                echo "${i}"
                ;;
        esac
    done | if [[ -t 1 ]] ; then
        fmt
    else
        cat
    fi
}

print_help () { echo -n "\
fe --help
fe --list-excludes
fe [--grep=<cmd>]     [<grep-options> ...] [<files> ...]
   [--allow-excludes]
"; }

main "$@"
