#!/usr/bin/env bash
set -o errexit
set -o pipefail
set -o nounset
shopt -s lastpipe

declare -i print_command=0
declare -a user_exclude_files=()
declare -a user_include_files=()

main () {
    if [[ -t 1 ]] ; then
        # add colors by default if stdout is a tty; can be turned off layer
        grep_options+=(--color=always)
    fi
    while (( $# )) ; do
        case "$1" in
            --print-command)
                print_command=1
                shift
                ;;
            --allow-excludes)
                exclude_dirs=()
                exclude_files=()
                shift
                ;;
            --list-excludes)
                list_excludes
                exit 0
                ;;
            --help)
                print_help
                exit 0
                ;;
            --grep)
                if (( $# < 2 )) ; then
                    echo "fe: option missing required argument - --grep"
                    exit 1
                fi
                grep="$2"
                shift 2
                ;;
            --grep=*)
                grep="${1#*=}"
                shift
                ;;
            --allow)
                if (( $# < 2 )) ; then
                    echo "fe: option missing required argument - --allow"
                    exit 1
                fi
                allow "$2"
                shift 2
                ;;
            --allow=*)
                allow "${1#*=}"
                shift
                ;;
            --non-ascii)
                grep_patterns+=(
                    -e "[^[:space:][:graph:][:cntrl:]]"
                )
                shift
                ;;
            --html-css-class)
                grep_patterns+=(
                    -e '[Cc][Ll][Aa][Ss][Ss][ \t]*=[ \t]*("[^"]*"|'\''[^'\'']*'\''|[^<>[:space:]]+)'
                )
                shift
                ;;
            -.html)
                user_include_files+=(--include="*.xhtml")
                user_include_files+=(--include="*.html")
                user_include_files+=(--include="*.htm")
                user_include_files+=(--include="*.php")
                shift
                ;;
            -.css)
                user_include_files+=(--include="*.css")
                user_include_files+=(--include="*.scss")
                shift
                ;;
            -.js)
                user_include_files+=(--include="*.js")
                user_include_files+=(--include="*.mjs")
                user_include_files+=(--include="*.cjs")
                user_include_files+=(--include="*.jsx")
                user_include_files+=(--include="*.es6")
                user_include_files+=(--include="*.es")
                user_include_files+=(--include="*.iced")
                user_include_files+=(--include="*.liticed")
                user_include_files+=(--include="*.iced.md")
                user_include_files+=(--include="*.cs")
                user_include_files+=(--include="*.coffee")
                user_include_files+=(--include="*.litcoffee")
                user_include_files+=(--include="*.coffee.md")
                user_include_files+=(--include="*.ts")
                user_include_files+=(--include="*.tsx")
                user_include_files+=(--include="*.ls")
                user_include_files+=(--include="*.sjs")
                user_include_files+=(--include="*.eg")
                shift
                ;;
            +.html)
                user_exclude_files+=(--exclude="*.xhtml")
                user_exclude_files+=(--exclude="*.html")
                user_exclude_files+=(--exclude="*.htm")
                user_exclude_files+=(--exclude="*.php")
                shift
                ;;
            +.css)
                user_exclude_files+=(--exclude="*.css")
                user_exclude_files+=(--exclude="*.scss")
                shift
                ;;
            +.js)
                user_exclude_files+=(--exclude="*.js")
                user_exclude_files+=(--exclude="*.mjs")
                user_exclude_files+=(--exclude="*.cjs")
                user_exclude_files+=(--exclude="*.jsx")
                user_exclude_files+=(--exclude="*.es6")
                user_exclude_files+=(--exclude="*.es")
                user_exclude_files+=(--exclude="*.iced")
                user_exclude_files+=(--exclude="*.liticed")
                user_exclude_files+=(--exclude="*.iced.md")
                user_exclude_files+=(--exclude="*.cs")
                user_exclude_files+=(--exclude="*.coffee")
                user_exclude_files+=(--exclude="*.litcoffee")
                user_exclude_files+=(--exclude="*.coffee.md")
                user_exclude_files+=(--exclude="*.ts")
                user_exclude_files+=(--exclude="*.tsx")
                user_exclude_files+=(--exclude="*.ls")
                user_exclude_files+=(--exclude="*.sjs")
                user_exclude_files+=(--exclude="*.eg")
                shift
                ;;
            -.*)
                user_include_files+=(--include="*.${1#-.}")
                shift
                ;;
            --.*)               # --.html only adds .html, for example
                user_include_files+=(--include="*.${1#--.}")
                shift
                ;;
            +.*)
                user_exclude_files+=(--exclude="*.${1#+.}")
                shift
                ;;
            ++.*)
                user_exclude_files+=(--exclude="*.${1#++.}")
                shift
                ;;
            *)
                break
                ;;
        esac
    done
    declare -a command=(
        "${grep}" -I -r "${user_include_files[@]}" "${user_exclude_files[@]}" "${grep_options[@]}" "${exclude_dirs[@]}" "${exclude_files[@]}" "${grep_patterns[@]}" "$@"
    )
    if (( print_command )) ; then
        echo "${command[@]@Q}"
    else
        exec "${command[@]}"
    fi
}

declare -a grep_options=()
declare -a grep_patterns=()

if [[ "${TERM}" = "emacs-grep" ]] ; then
    # invoked from M-x grep, either directly or indirectly
    grep_options+=(--color=auto -nH --null)
fi

grep=grep
if [[ -v OSTYPE ]] && [[ "${OSTYPE}" = "darwin"* ]] && type -P ggrep >/dev/null ; then
    grep=ggrep
fi

list_excludes () {
    local IFS=$'\n'
    echo "# directories"
    echo "${exclude_dirs[*]#--*=}" | if [[ -t 1 ]] ; then fmt ; else cat ; fi
    echo "# files"
    echo "${exclude_files[*]#--*=}" | if [[ -t 1 ]] ; then fmt ; else cat ; fi
}

print_help () { echo -n "\
fe --help
fe --list-excludes
fe [--grep=<cmd>]           [<grep-options> ...] [<files> ...]
   [--print-command]
   [--allow-excludes]
   [--print-command]
   [--non-ascii]
   [--html-css-class]
   [-.<ext>]  [+.<ext>]     include/exclude *.<ext> (html, css, js are special)
   [--.<ext>] [++.<ext>]    non-special include/exclude
NOTE: fe options must come before grep options.
"; }

# exclude_from array_variable value ...
delete_from_excludes () {
    local varname="$1"; shift
    local -n var="${varname}"
    local -a new_array=()
    local i
    local j
    for i in "${var[@]}" ; do
        for j in "$@" ; do
            for k in "--exclude=$j" "--exclude-dir=$j" ; do
                if [[ "$i" == "$k" ]] ; then
                    continue 3
                fi
            done
        done
        new_array+=("$i")
    done
    var=("${new_array[@]}")
}

allow () {
    echo "${#exclude_dirs[@]} ${#exclude_files[@]}"
    delete_from_excludes exclude_dirs "$@"
    delete_from_excludes exclude_files "$@"
    echo "${#exclude_dirs[@]} ${#exclude_files[@]}"
}

declare -a exclude_dirs=()
exclude_dirs () {
    (( $# < 1 )) && return
    exclude_dirs+=(--exclude-dir="$1")
}
. "$(dirname "$0")/../share/fe/exclude-dirs.sh"

declare -a exclude_files=()
exclude_files () {
    (( $# < 1 )) && return
    exclude_files+=(--exclude-dir="$1")
}
. "$(dirname "$0")/../share/fe/exclude-files.sh"

main "$@"
