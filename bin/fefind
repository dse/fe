#!/usr/bin/env bash
set -o errexit
set -o pipefail
set -o nounset
shopt -s lastpipe

declare -i print_command=0
declare -a user_exclude_files=()
declare -a user_include_files=()

main () {
    while (( $# )) ; do
        case "$1" in
            --print-command)
                print_command=1
                shift
                ;;
            --list-excludes)
                list_excludes
                exit 0
                ;;
            -.html)
                user_include_files+=(-o -name "*.xhtml")
                user_include_files+=(-o -name "*.html")
                user_include_files+=(-o -name "*.htm")
                user_include_files+=(-o -name "*.php")
                shift
                ;;
            -.css)
                user_include_files+=(-o -name "*.css")
                user_include_files+=(-o -name "*.scss")
                shift
                ;;
            -.js)
                user_include_files+=(-o -name "*.js")
                user_include_files+=(-o -name "*.mjs")
                user_include_files+=(-o -name "*.cjs")
                user_include_files+=(-o -name "*.jsx")
                user_include_files+=(-o -name "*.es6")
                user_include_files+=(-o -name "*.es")
                user_include_files+=(-o -name "*.iced")
                user_include_files+=(-o -name "*.liticed")
                user_include_files+=(-o -name "*.iced.md")
                user_include_files+=(-o -name "*.cs")
                user_include_files+=(-o -name "*.coffee")
                user_include_files+=(-o -name "*.litcoffee")
                user_include_files+=(-o -name "*.coffee.md")
                user_include_files+=(-o -name "*.ts")
                user_include_files+=(-o -name "*.tsx")
                user_include_files+=(-o -name "*.ls")
                user_include_files+=(-o -name "*.sjs")
                user_include_files+=(-o -name "*.eg")
                shift
                ;;
            +.html)
                user_exclude_files+=(\! -name "*.xhtml")
                user_exclude_files+=(\! -name "*.html")
                user_exclude_files+=(\! -name "*.htm")
                user_exclude_files+=(\! -name "*.php")
                shift
                ;;
            +.css)
                user_exclude_files+=(\! -name "*.css")
                user_exclude_files+=(\! -name "*.scss")
                shift
                ;;
            +.js)
                user_exclude_files+=(\! -name "*.js")
                user_exclude_files+=(\! -name "*.mjs")
                user_exclude_files+=(\! -name "*.cjs")
                user_exclude_files+=(\! -name "*.jsx")
                user_exclude_files+=(\! -name "*.es6")
                user_exclude_files+=(\! -name "*.es")
                user_exclude_files+=(\! -name "*.iced")
                user_exclude_files+=(\! -name "*.liticed")
                user_exclude_files+=(\! -name "*.iced.md")
                user_exclude_files+=(\! -name "*.cs")
                user_exclude_files+=(\! -name "*.coffee")
                user_exclude_files+=(\! -name "*.litcoffee")
                user_exclude_files+=(\! -name "*.coffee.md")
                user_exclude_files+=(\! -name "*.ts")
                user_exclude_files+=(\! -name "*.tsx")
                user_exclude_files+=(\! -name "*.ls")
                user_exclude_files+=(\! -name "*.sjs")
                user_exclude_files+=(\! -name "*.eg")
                shift
                ;;
            -.*)
                user_include_files+=(-o -name "*.${1#-.}")
                shift
                ;;
            --.*)               # --.html only adds .html, for example
                user_include_files+=(-o -name "*.${1#--.}")
                shift
                ;;
            +.*)
                user_exclude_files+=(\! -name "*.${1#+.}")
                shift
                ;;
            ++.*)
                user_exclude_files+=(\! -name "*.${1#++.}")
                shift
                ;;
            *)
                break
                ;;
        esac
    done

    # parse command line arguments in the same way find does.

    declare -a find_options=()
    while (( $# )) ; do
        case "$1" in
            -P|-L|-H)
                find_options+=("$1")
                shift
                ;;
            -D|-O)
                if (( $# < 2 )) ; then
                    echo "option missing required argument - $1"
                    exit 1
                fi
                find_options+=("$1" "$2")
                shift 2
                ;;
            -D*|-O*)
                find_options+=("$1")
                shift
                ;;
            *)
                # ends options; starting point arguments follow
                break
                ;;
        esac
    done

    declare -a find_targets=()
    while (( $# )) ; do
        case "$1" in
            "!"|"("|-*)
                # ends starting points; find expression follows
                break
                ;;
            *)
                find_targets+=("$1")
                shift
                ;;
        esac
    done

    # File exclusions work a bit differently, so we don't need to do
    # this for them.
    if (( ${#user_include_files[@]} )) ; then
        user_include_files[0]='('
        user_include_files+=(')')
    fi

    declare -a command=(
        find "${find_options[@]}" "${find_targets[@]}" "${exclude_dirs[@]}" -type f "${user_include_files[@]}" "${user_exclude_files[@]}" "${exclude_files[@]}" "$@"
    )
    if (( print_command )) ; then
        echo "${command[@]@Q}"
    else
        exec "${command[@]}"
    fi
}

list_excludes () {
    local i
    echo "# directories"
    for (( i = 5; i <= ${#exclude_dirs[@]}; i += 8 )) ; do
        echo "${exclude_dirs[$i]}"
    done | if [[ -t 1 ]] ; then fmt ; else cat ; fi
    echo "# files"
    for (( i = 2; i <= ${#exclude_files[@]}; i += 3 )) ; do
        echo "${exclude_files[$i]}"
    done | if [[ -t 1 ]] ; then fmt ; else cat ; fi
}

declare -a exclude_dirs=(
    \! \( -type d -name .git -prune \)
    \! \( -type d -name node_modules -prune \)
    \! \( -type d -name _cacache -prune \)
    \! \( -type d -name .node-gyp -prune \)
    \! \( -type d -name vendor -prune \)
    \! \( -type d -name cache -prune \)
)

declare -a exclude_files=(
    \! -name '*~'
    \! -name '#*#'
    \! -name '*.tmp'
    \! -name '*.bak'
    \! -name '*.orig'
    \! -name '*.old'
    \! -name '*.tmp.*'
    \! -name '*.bak.*'
    \! -name '*.orig.*'
    \! -name '*.old.*'

    # executable
    \! -name '*.exe'
    \! -name '*.com'

    # shared libraries
    \! -name '*.so'
    \! -name '*.so.*'
    \! -name '*.dll'
    \! -name '*.dynlib'
    \! -name '*.dylib'

    # compiled formats
    \! -name '*.pyc'
    \! -name '*.elc'

    # image
    \! -name '*.jpg'
    \! -name '*.jpeg'
    \! -name '*.gif'
    \! -name '*.png'
    \! -name '*.bmp'
    \! -name '*.webp'
    \! -name '*.tif'
    \! -name '*.tiff'
    \! -name '*.ppm'
    \! -name '*.pgm'
    \! -name '*.pbm'
    \! -name '*.pnm'

    # audio
    \! -name '*.3gp'
    \! -name '*.aa'
    \! -name '*.aac'
    \! -name '*.aax'
    \! -name '*.act'
    \! -name '*.aiff'
    \! -name '*.alac'
    \! -name '*.amr'
    \! -name '*.ape'
    \! -name '*.au'
    \! -name '*.awb'
    \! -name '*.dss'
    \! -name '*.dvf'
    \! -name '*.flac'
    \! -name '*.gsm'
    \! -name '*.iklax'
    \! -name '*.ivs'
    \! -name '*.m4a'
    \! -name '*.m4b'
    \! -name '*.m4p'
    \! -name '*.mmf'
    \! -name '*.movpkg'
    \! -name '*.mp3'
    \! -name '*.mpc'
    \! -name '*.msv'
    \! -name '*.nmf'
    \! -name '*.ogg'
    \! -name '*.oga'
    \! -name '*.mogg'
    \! -name '*.opus'
    \! -name '*.ra'
    \! -name '*.rm'
    \! -name '*.raw'
    \! -name '*.rf64'
    \! -name '*.sln'
    \! -name '*.tta'
    \! -name '*.voc'
    \! -name '*.vox'
    \! -name '*.wav'
    \! -name '*.wma'
    \! -name '*.wv'
    \! -name '*.webm'
    \! -name '*.8svx'
    \! -name '*.cda'

    # video
    \! -name '*.webm'
    \! -name '*.mkv'
    \! -name '*.flv'
    \! -name '*.vob'
    \! -name '*.ogv'
    \! -name '*.ogg'
    \! -name '*.drc'
    \! -name '*.gif'
    \! -name '*.gifv'
    \! -name '*.mng'
    \! -name '*.avi'
    \! -name '*.MTS'
    \! -name '*.M2TS'
    \! -name '*.TS'
    \! -name '*.mov'
    \! -name '*.qt'
    \! -name '*.wmv'
    \! -name '*.yuv'
    \! -name '*.rm'
    \! -name '*.rmvb'
    \! -name '*.viv'
    \! -name '*.asf'
    \! -name '*.amv'
    \! -name '*.mp4'
    \! -name '*.m4p'
    \! -name '*.m4v'
    \! -name '*.mpg'
    \! -name '*.mp2'
    \! -name '*.mpeg'
    \! -name '*.mpe'
    \! -name '*.mpv'
    \! -name '*.mpg'
    \! -name '*.mpeg'
    \! -name '*.m2v'
    \! -name '*.m4v'
    \! -name '*.svi'
    \! -name '*.3gp'
    \! -name '*.3g2'
    \! -name '*.mxf'
    \! -name '*.roq'
    \! -name '*.nsv'
    \! -name '*.flv'
    \! -name '*.f4v'
    \! -name '*.f4p'
    \! -name '*.f4a'
    \! -name '*.f4b'

    # HEIF - High Efficiency Image File Format
    \! -name '*.heif'
    \! -name '*.heifs'
    \! -name '*.heic'
    \! -name '*.heics'
    \! -name '*.avci'
    \! -name '*.avcs'
    \! -name '*.HIF'

    # archive formats
    \! -name '*.a'
    \! -name '*.ar'
    \! -name '*.cpio'
    \! -name '*.shar'
    \! -name '*.LBR'
    \! -name '*.iso'
    \! -name '*.lbr'
    \! -name '*.mar'
    \! -name '*.sbx'
    \! -name '*.tar'

    # compression formats
    \! -name '*.br'
    \! -name '*.bz2'
    \! -name '*.F'
    \! -name '*.?XF'
    \! -name '*.genozip'
    \! -name '*.gz'
    \! -name '*.lz'
    \! -name '*.lz4'
    \! -name '*.lzma'
    \! -name '*.lzo'
    \! -name '*.rz'
    \! -name '*.sfark'
    \! -name '*.sz'
    \! -name '*.?Q?'
    \! -name '*.?Z?'
    \! -name '*.xz'
    \! -name '*.z'
    \! -name '*.Z'
    \! -name '*.zst'
    \! -name '*.??_'

    # archive and compression formats
    \! -name '*.7z'
    \! -name '*.s7z'
    \! -name '*.aar'
    \! -name '*.ace'
    \! -name '*.afa'
    \! -name '*.alz'
    \! -name '*.apk'
    \! -name '*.arc'
    \! -name '*.ark'
    \! -name '*.cdx'
    \! -name '*.arj'
    \! -name '*.b1'
    \! -name '*.b6z'
    \! -name '*.ba'
    \! -name '*.bh'
    \! -name '*.cab'
    \! -name '*.car'
    \! -name '*.cfs'
    \! -name '*.cpt'
    \! -name '*.dar'
    \! -name '*.dd'
    \! -name '*.dgc'
    \! -name '*.dmg'
    \! -name '*.ear'
    \! -name '*.gca'
    \! -name '*.genozip'
    \! -name '*.ha'
    \! -name '*.hki'
    \! -name '*.ice'
    \! -name '*.jar'
    \! -name '*.kgb'
    \! -name '*.lzh'
    \! -name '*.lza'
    \! -name '*.lzx'
    \! -name '*.pak'
    \! -name '*.partimg'
    \! -name '*.paq6'
    \! -name '*.paq7'
    \! -name '*.paq8'
    \! -name '*.pea'
    \! -name '*.phar'
    \! -name '*.pim'
    \! -name '*.pit'
    \! -name '*.qda'
    \! -name '*.rar'
    \! -name '*.rk'
    \! -name '*.sda'
    \! -name '*.sea'
    \! -name '*.sen'
    \! -name '*.sfx'
    \! -name '*.shk'
    \! -name '*.sit'
    \! -name '*.sitx'
    \! -name '*.sqx'
    \! -name '*.uc'
    \! -name '*.uc0'
    \! -name '*.uc2'
    \! -name '*.ucn'
    \! -name '*.ur2'
    \! -name '*.ue2'
    \! -name '*.uca'
    \! -name '*.uha'
    \! -name '*.war'
    \! -name '*.wim'
    \! -name '*.xar'
    \! -name '*.xp3'
    \! -name '*.yz1'
    \! -name '*.zip'
    \! -name '*.zipx'
    \! -name '*.zoo'
    \! -name '*.zpaq'
    \! -name '*.zz'

    # shorthands for *.tar.*
    \! -name '*.tgz'
    \! -name '*.tbz2'
    \! -name '*.tlz'
    \! -name '*.txz'

    # data recovery, error correction
    \! -name '*.ecc'
    \! -name '*.ecsbx'
    \! -name '*.par'
    \! -name '*.par2'
    \! -name '*.rev'

    # bloat
    \! -name '*.min'
    \! -name '*.min.*'
    \! -name '*.bundle'
    \! -name '*.bundle.*'
    \! -name 'package-lock.json'
    \! -name 'composer.lock'
    \! -name 'yarn.lock'
    \! -name '*.log'
    \! -name '*.css.map'
    \! -name '*.js.map'
    \! -name '*.min.map'
)

main "$@"
